<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.min.js"></script>
    <style>
        .bar:hover {
            transition-duration: 0s;
            opacity: 0.3;
        }

        .tick {
            font-size: 12px;
            fill: #555;
        }

        div {
            border: 1px solid #efefef;
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            width: 60px;
            height: auto;
            padding: 2px;
            font: 12px sans-serif;
            background: lavender;
            border: 0px;
            border-radius: 4px;
            padding: 6px;
            pointer-events: none;
            opacity: 0;
        }
    </style>

</head>

<body>
    <div></div>
    <script>
        //console.log(fetchData());
        fetchData();
        function fetchData() {
            let url = "https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/GDP-data.json";
            fetch(url).then(response => response.json()).then(data => {
                console.log(data.data);
                visualizeData(data.data);
            });
            //data.data becuz: first data is the argument of "then", second data is a property in the returned object, this property is an array
            /*from fcc
            The first line is the one that makes the request. So, fetch(URL) makes a GET request to the URL specified. The method returns a Promise.
    
            After a Promise is returned, if the request was successful, the then method is executed, which takes the response and converts it to JSON format.
    
            The then method also returns a Promise, which is handled by the next then method.
            */
        }

        function visualizeData(dataset) {

            const w = 800;
            const h = 500;
            const padding = 50;
            const barWidth = w / dataset.length/*3*/;

            //adding svg tag to the body with height and width
            const svg = d3.selectAll("div").append("svg").attr("width", w).attr("height", h);

            //adding scales
            //const xScale = d3.scaleLinear().domain([0, d3.max(dataset, (d)=>d[0].slice(0,4))]).range([padding, w-padding]);
            var xScale = d3.scaleTime()//this method is special to scaling dates
                .domain([
                    d3.min(dataset, (d) => new Date(d[0])),
                    d3.max(dataset, (d) => new Date(d[0]))
                ])//taking min & max of dataset & create two dates of it to be the 'domain' attributes
                .range([padding, w - padding])//teeling d3 that in ui the range of xscaling is from 50 (padding) to 750 (w-padding)
                ;
            const yScale = d3.scaleLinear()//this methid scaleLinear() is used to do scaling for quantitative data
                .domain([0, d3.max(dataset, (d) => d[1])])//telling d3 the min(which is 0 for quantitative data) & max of data to be attributes for 'domain'
                .range([(h - padding), padding])//teeling d3 that in ui the range of yscaling is from 450 (h-padding) to 50 (padding)
                ;


            /*
            the below div is going to be shown when user hover over a bar, it holds the date & gdp value,
            we can do it using rect.append("title").text(...) but the test requires a seperate div that will de shown onmouseover and hidden onmouseout
            */
            let tooltip = d3
                .select("body")
                .append("div")
                .attr("class", "tooltip")
                .attr("id", "tooltip");



            //adding rect svg tags using the dataset
            svg.selectAll("rect")
                .data(dataset)//linking the dataset to the set of rect elements
                .enter()//if rect elements number is fewer than dataset items, then, new rect elements will be appended automatically with the next line of code
                .append("rect")//here d3 will add new rect elements to have same number as dataset items
                .attr("x", (d) => xScale(new Date(d[0])))//x position is generated by the xScale
                .attr("y", (d) => yScale(d[1]))//x position is generated by the yScale
                .attr("width", barWidth)//setting the width of a bar
                .attr("height", (d) => h - padding - yScale(d[1]))//height bar is generated by yScale and we subtracted it from the height to be right-side-up
                .attr("fill", "navy")//setting fill color of rect elements
                .attr("class", "bar")//adding a class to the rect elements so that it will have a hover effect
                .attr("data-date", (d) => d[0])//set a new attribute "data-date" for each rect element to store 'date' information
                .attr("data-gdp", (d) => d[1])//set a new attribute "data-gdp" for each rect element to store 'gdp' information
                /*THIS WORKS FINE BUT THE TEST REQUIRES THE NEXT ONMOUSEOVER AND ONMOUSEOUT FUNCTIONS
                                .append("title").text((d) => (d[0] + "\n" + "$" + d[1] + " Billion"))//adding a title to every rect element that will be displayed once user hover over a bar
                                */
                .on("mouseover", function (d) {
                    //we'll display the div stored in the variable tooltip
                    tooltip
                        .html(d[0] + "\n" + d[1] + " $")//setting the text onside the div tooltip
                        /*
                         THIS USES THE MOUSE POSITION AND ADD 10 PX TO IT AND SHOW THE TOOLTIP DIV
                        .style("left", d3.event.pageX + 10 + "px")
                        .style("top", d3.event.pageY + 10 + "px")
                        */
                        /* THIS USES THE BAR POSITION AND PUT THE TOOLTIP DIV ON IT (TOOLTIP DIV WILL BE ON THE TOP OF THE BAR)*/
                        .style("left", d3.select(this).attr("x") + "px")//gets the bar x attribute value and assign it the 'left' property of tooltip div
                        .style("top", d3.select(this).attr("y") + "px")//gets the bar y attribute value and assign it the 'top' property of tooltip div
                        .transition()//because we cannot use duration() without using transition()
                        .duration(200)//duration of transition will be 200ms
                        .style("opacity", 0.9)//this is the transition: opacity will be increased from 0 to 0.9
                        ;
                    tooltip.attr("data-date", d[0])//this is used bcuz test asked so
                        ;
                }).on("mouseout", function (d) {
                    //we'll hide the div stored in the variable tooltip
                    tooltip
                        .transition()//because we cannot use duration() without using transition()
                        .duration(300)//duration of transition will be 300ms
                        .style("opacity", 0);//this is the transition: opacity will be decreased from 0.9 to 0 again
                })
                ;

            //adding xAxis
            const xAxis = d3.axisBottom(xScale);//this is the xAxis that we'll use with 'g' element in a call() method
            svg.append("g")
                .attr("id", "x-axis")
                .attr("transform", "translate(0, " + (h - padding) + ")")//we'll move the xAxis to the bottom of the svg
                .call(xAxis);

            //adding yAxis
            const yAxis = d3.axisLeft(yScale)//this is the yAxis that we'll use with 'g' element in a call() method
                ;
            svg.append("g")
                .attr("id", "y-axis")
                .attr("transform", "translate(" + padding + ", 0)")//we'll move the yAxis to the extreme left of the svg
                .call(yAxis);

            //adding a "tick" class to all ticks svg elements of both axes
            svg.selectAll("ticks").attr("class", "tick");

            //adding the text 'United States GDP' in top center of the svg element
            svg.append("text")//appending a text element to the svg
                .attr("x", w / 2)//setting the x of text element to start from the center of the svg element
                .attr("y", 0 + padding)//setting the y of text element to start the top of the svg element
                .attr("text-anchor", "middle")//this will make the text perfectly centered (setting only the x is not enough)
                .attr("fill", "black")//setting text color to black
                .attr("id", "title")
                .style("font-size", "20px")
                .text("United States GDP (Quarterly)");


            //adding the text "More Information: http://www.bea.gov/national/pdf/nipaguid.pdf" in the bottom right of the svg element
            svg.append("text")
                .attr("x", w / 2)
                .attr("y", h - 10)
                .attr("text-anchor", "middle")
                .attr("fill", "#555")
                .attr("font-size", "15px")
                .text("More Information: http://www.bea.gov/national/pdf/nipaguid.pdf")
                ;

        }
    </script>
</body>

</html>